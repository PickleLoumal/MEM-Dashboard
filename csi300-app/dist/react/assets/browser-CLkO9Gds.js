import{R as Z,j as n,a as ee,r as l,G as ne}from"./main-CQ9334la.js";const te=[{id:"name",displayName:"Company Name"},{id:"ticker",displayName:"Ticker"},{id:"region",displayName:"Region"},{id:"im_sector",displayName:"IM Sector"},{id:"market_cap_usd",displayName:"Market Cap (USD Million)",align:"right"},{id:"price",displayName:"Price (Local Currency)",align:"right"},{id:"pe_ratio_trailing",displayName:"P/E Ratio",align:"right"}],q="https://your-api.example.com".replace(/\/$/,""),se="/api/csi300/api/companies/filter_options/",ie="/api/csi300/api/companies/",F=300;function ae(e){const s=new URLSearchParams;e&&Object.entries(e).forEach(([r,o])=>o&&s.append(r,o));const a=s.toString();return`${q}${se}${a?`?${a}`:""}`}async function A(e){const s=await fetch(ae(e),{headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);return s.json()}async function re(e){const s=new URLSearchParams;e.im_sector&&s.append("im_sector",e.im_sector),e.industry&&s.append("industry",e.industry),e.company_search&&s.append("search",e.company_search),e.industry_search&&s.append("industry_search",e.industry_search),e.region&&s.append("region",e.region.replace(/\s*\(.*\)$/,"")),s.append("page",String(e.page)),s.append("page_size",String(e.page_size));const a=`${q}${ie}?${s.toString()}`,r=await fetch(a,{headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}});if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);return r.json()}function oe(e){return e?e.total_count??e.company_count??e.total_companies??null:null}function le(e){return Array.from(new Set((e||[]).filter(Boolean))).sort((s,a)=>s.toLowerCase().localeCompare(a.toLowerCase()))}function D(e){const s=new Set,a=r=>r?.forEach(o=>o&&s.add(o));return e&&(a(e.regions),a(e.available_regions),a(e.region_options),e.region_counts&&Object.keys(e.region_counts).forEach(r=>r&&s.add(r))),s.size||["Mainland China","Hong Kong"].forEach(r=>s.add(r)),le(Array.from(s))}function ce(e){return e?e.im_sectors?.length?e.im_sectors:e.im_codes?.length?e.im_codes:e.industries?.length?e.industries:[]:[]}function O(e){return e?e.industries?.length?e.industries:e.im_sectors?.length?e.im_sectors:e.im_codes?.length?e.im_codes:[]:[]}function de(e,s){const a=s[e];if(a==null||a==="")return"-";if(typeof a=="number"){if(e.includes("price")||e.includes("pe_ratio"))return a.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});if(e.includes("market_cap"))return a.toLocaleString("en-US",{maximumFractionDigits:0})}return String(a)}function ue(e){if(!e)return{label:"All Regions",attr:"all"};const s=e.toLowerCase();return s.includes("hong")?{label:"Hong Kong",attr:"hong-kong"}:s.includes("china")?{label:"Mainland China",attr:"mainland-china"}:{label:e,attr:"unknown"}}function U(e,s={}){return new Promise((a,r)=>{if(document.querySelector(`script[src="${e}"]`)){a();return}const o=document.createElement("script");o.src=e,o.defer=!0,Object.entries(s).forEach(([m,u])=>o.setAttribute(m,u)),o.onload=()=>a(),o.onerror=()=>r(new Error(`Failed to load ${e}`)),document.body.appendChild(o)})}function me({page:e,pages:s,onPageChange:a}){if(s<=1)return null;const r=5;let o=Math.max(1,e-Math.floor(r/2)),m=Math.min(s,o+r-1);m-o+1<r&&(o=Math.max(1,m-r+1));const u=[];for(let c=o;c<=m;c++)u.push(c);return n.jsxs("div",{className:"pagination",id:"pagination",children:[n.jsx("button",{onClick:()=>a(e-1),disabled:e<=1,children:"← Previous"}),u.map(c=>n.jsx("button",{className:c===e?"current-page":"",onClick:()=>a(c),children:c},c)),n.jsx("button",{onClick:()=>a(e+1),disabled:e>=s,children:"Next →"})]})}function pe(e,s){const a=l.useRef(!1);l.useEffect(()=>{a.current||(a.current=!0,(async()=>{try{if(await U("/config/column-manifest.js"),await U("/assets/js/components/column-selector.js"),window.CSI300ColumnManifest&&window.CSI300ColumnSelector){const r=new window.CSI300ColumnSelector(window.CSI300ColumnManifest,{container:"#columnSelectorContainer",onColumnChange:o=>{e(o.columns),s(o.pinnedColumns)}});e(r.getSelectedColumns()),s(r.getPinnedColumns().map(o=>o.id))}}catch(r){console.error("Column selector load failed",r)}})())},[e,s])}function he(){const[e,s]=l.useState({im_sector:"",industry:"",company_search:"",industry_search:"",region:""}),[a,r]=l.useState(""),[o,m]=l.useState(""),u=l.useRef(null),c=l.useRef(null),[f,_]=l.useState(null),[B,w]=l.useState([]),[z,C]=l.useState([]),[v,g]=l.useState(!1),[j,E]=l.useState([]),[R,M]=l.useState(0),[S,p]=l.useState(1),k=20,[T,L]=l.useState(!1),[P,y]=l.useState(null),[N,X]=l.useState([]),[x,K]=l.useState([]);pe(X,K),l.useEffect(()=>{const t=new URLSearchParams(window.location.search),i={im_sector:t.get("im_sector")||t.get("im_code")||"",industry:t.get("industry")||t.get("sub_industry")||"",company_search:t.get("company_search")||t.get("search")||"",industry_search:t.get("industry_search")||"",region:t.get("region")||""};s(i),r(i.company_search),m(i.industry_search)},[]),l.useEffect(()=>{let t=!1;return g(!0),A(e.im_sector?{im_sector:e.im_sector}:void 0).then(i=>{t||(_(i),w(O(i)),C(D(i)))}).catch(i=>{t||y(i instanceof Error?i.message:"筛选项加载失败")}).finally(()=>{t||g(!1)}),()=>{t=!0}},[e.im_sector]),l.useEffect(()=>{let t=!1;return L(!0),y(null),re({...e,page:S,page_size:k}).then(i=>{t||(Array.isArray(i)?(E(i),M(i.length)):i?.results?(E(i.results),M(i.count||0)):y("Unexpected response format"))}).catch(i=>{t||y(i instanceof Error?i.message:"加载公司列表失败")}).finally(()=>{t||L(!1)}),()=>{t=!0}},[e,S]),l.useMemo(()=>oe(f),[f]);const G=l.useMemo(()=>ce(f),[f]),I=t=>i=>{s(d=>({...d,[t]:i.target.value})),t!=="industry"&&p(1)},W=async t=>{const i=t.target.value;s(d=>({...d,im_sector:i,industry:""})),p(1);try{g(!0);const d=await A(i?{im_sector:i}:void 0);_(d),w(O(d)),C(D(d))}catch(d){console.error("Sector change load failed",d)}finally{g(!1)}},V=T?"Loading...":`${R} companies`,J=t=>{t.preventDefault(),p(1);const i=new URLSearchParams;Object.keys(e).forEach(h=>{const b=e[h].trim();b&&i.append(h,b)});const d=i.toString();window.history.replaceState({},"",d?`?${d}`:window.location.pathname)},Q=()=>{s({im_sector:"",industry:"",company_search:"",industry_search:"",region:""}),r(""),m(""),p(1),window.history.replaceState({},"",window.location.pathname)},Y=Math.max(1,Math.ceil(R/k)),$=l.useMemo(()=>{const t=N?.length?N:te;if(!x.length)return t;const i=x.map(h=>t.find(b=>b.id===h)).filter(Boolean),d=t.filter(h=>!x.includes(h.id));return[...i,...d]},[N,x]);return l.useEffect(()=>(u.current&&window.clearTimeout(u.current),u.current=window.setTimeout(()=>{s(t=>({...t,company_search:a})),p(1)},F),()=>{u.current&&window.clearTimeout(u.current)}),[a]),l.useEffect(()=>(c.current&&window.clearTimeout(c.current),c.current=window.setTimeout(()=>{s(t=>({...t,industry_search:o})),p(1)},F),()=>{c.current&&window.clearTimeout(c.current)}),[o]),n.jsxs(n.Fragment,{children:[n.jsx(ne,{}),n.jsxs("div",{className:"container",children:[n.jsx("div",{className:"page-header",children:n.jsx("h1",{className:"page-title",children:"Chinese Stock Search Results"})}),P?n.jsx("div",{className:"error app-notice",children:P}):null,n.jsxs("form",{className:"filter-section app-card",onSubmit:J,children:[n.jsxs("div",{className:"filter-grid app-form-grid app-form-grid--two",children:[n.jsxs("div",{className:"filter-group app-form-field",children:[n.jsx("label",{className:"filter-label app-label",children:"IM Sector"}),n.jsxs("select",{name:"im_sector",value:e.im_sector,onChange:W,className:"filter-select app-select",children:[n.jsx("option",{value:"",children:"All IM Sectors"}),G.map(t=>n.jsx("option",{value:t,children:t},t))]})]}),n.jsxs("div",{className:"filter-group app-form-field",children:[n.jsx("label",{className:"filter-label app-label",children:"Region"}),n.jsxs("select",{name:"region",value:e.region,onChange:I("region"),className:"filter-select app-select",children:[n.jsx("option",{value:"",children:"All Regions"}),z.map(t=>n.jsx("option",{value:t,children:t},t))]}),n.jsx("p",{className:"filter-help",children:"Hong Kong reflects the latest H-shares dataset."})]}),n.jsxs("div",{className:"filter-group app-form-field",children:[n.jsx("label",{className:"filter-label app-label",children:"Industry within selected sector"}),n.jsxs("select",{name:"industry",value:e.industry,onChange:I("industry"),className:"filter-select app-select",disabled:v,children:[n.jsx("option",{value:"",children:v?"Loading...":"All Industries"}),B.map(t=>n.jsx("option",{value:t,children:t},t))]})]}),n.jsxs("div",{className:"filter-group app-form-field",children:[n.jsx("label",{className:"filter-label app-label",children:"Search Companies"}),n.jsx("input",{type:"text",name:"company_search",value:a,onChange:t=>r(t.target.value),className:"filter-input app-input",placeholder:"Search by company name or ticker..."})]}),n.jsxs("div",{className:"filter-group app-form-field",children:[n.jsx("label",{className:"filter-label app-label",children:"Search by Industry"}),n.jsx("input",{type:"text",name:"industry_search",value:o,onChange:t=>m(t.target.value),className:"filter-input app-input",placeholder:"Search by industry name..."})]})]}),n.jsxs("div",{className:"filter-actions app-actions",children:[n.jsx("button",{type:"button",onClick:Q,className:"btn btn-secondary app-button app-button--secondary",children:"Clear Filters"}),n.jsx("button",{type:"submit",className:"btn btn-primary app-button app-button--primary",children:"Apply Filters"})]})]}),n.jsxs("div",{className:"results-section app-card",children:[n.jsxs("div",{className:"results-header",children:[n.jsxs("div",{children:[n.jsx("h2",{className:"results-title",children:"Search Results"}),n.jsx("p",{className:"results-count",id:"resultsCount",children:V})]}),n.jsxs("div",{className:"results-meta",children:[(()=>{const t=ue(e.region);return n.jsx("span",{className:"region-badge","data-region":t.attr,children:t.label})})(),n.jsx("div",{id:"columnSelectorContainer"})]})]}),T?n.jsx("div",{className:"loading",children:n.jsx("p",{children:"Loading companies..."})}):j.length===0?n.jsx("div",{className:"no-results",children:n.jsx("p",{children:"No companies found matching the criteria"})}):n.jsxs("div",{id:"resultsContainer",children:[n.jsxs("table",{className:"company-table app-table",id:"companyTable",children:[n.jsx("thead",{children:n.jsx("tr",{children:$.map(t=>n.jsx("th",{className:t.align==="right"?"text-right":t.align==="center"?"text-center":"text-left",children:t.displayName},t.id))})}),n.jsx("tbody",{id:"companyTableBody",children:j.map(t=>n.jsx("tr",{className:"clickable-row",onClick:()=>window.location.href=`detail.html?id=${t.id}`,children:$.map(i=>n.jsx("td",{className:i.align==="right"?"text-right":i.align==="center"?"text-center":"text-left",children:de(i.id,t)},i.id))},t.id))})]}),n.jsx("div",{className:"mobile-company-list",id:"mobileCompanyList",children:j.map(t=>n.jsxs("div",{className:"mobile-company-card",onClick:()=>window.location.href=`detail.html?id=${t.id}`,children:[n.jsxs("div",{className:"mobile-company-header",children:[n.jsx("div",{className:"mobile-company-name",children:t.name}),n.jsx("div",{className:"mobile-company-ticker",children:t.ticker})]}),n.jsxs("div",{className:"mobile-company-details",children:[n.jsxs("div",{className:"mobile-company-detail",children:[n.jsx("span",{className:"mobile-company-detail-label",children:"Region"}),n.jsx("span",{className:"mobile-company-detail-value",children:t.region||"-"})]}),n.jsxs("div",{className:"mobile-company-detail",children:[n.jsx("span",{className:"mobile-company-detail-label",children:"IM Sector"}),n.jsx("span",{className:"mobile-company-detail-value",children:t.im_sector||"-"})]}),n.jsxs("div",{className:"mobile-company-detail",children:[n.jsx("span",{className:"mobile-company-detail-label",children:"Industry"}),n.jsx("span",{className:"mobile-company-detail-value",children:t.industry||"-"})]}),n.jsxs("div",{className:"mobile-company-detail",children:[n.jsx("span",{className:"mobile-company-detail-label",children:"Market Cap (USD M)"}),n.jsx("span",{className:"mobile-company-detail-value",children:typeof t.market_cap_usd=="number"?t.market_cap_usd.toLocaleString("en-US",{maximumFractionDigits:0}):"-"})]})]})]},t.id))}),n.jsx(me,{page:S,pages:Y,onPageChange:p})]})]})]})]})}const H=document.getElementById("root");if(!H)throw new Error("Root element not found");Z.createRoot(H).render(n.jsx(ee.StrictMode,{children:n.jsx(he,{})}));
