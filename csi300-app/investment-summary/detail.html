<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Summary - Chinese Stock Dashboard</title>
    
    <!-- Favicon (using base64 to avoid 404) -->
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==">
    
    <!-- Framework and styling imports -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/app-base.css">
    <link rel="stylesheet" href="../assets/css/global-nav.css">
    <link rel="stylesheet" href="assets/investment-summary.css">
    <script src="../assets/js/components/global-nav.js"></script>
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
</head>
<body>
    
    <div class="container app-shell">
        <!-- Loading State -->
        <div id="loadingState" class="loading-spinner">
            <div class="spinner"></div>
        </div>
        
        <!-- Error State -->
        <div id="errorState" class="error-message" style="display: none;">
            <h3>Investment Summary Not Available</h3>
            <p>No investment summary found for this company. Please check back later.</p>
        </div>
        
        <!-- Investment Summary Content -->
        <div id="investmentSummaryContent" style="display: none;">
            <!-- Header -->
            <div class="investment-summary-header">
                <h1 id="summaryTitle">Investment Summary</h1>
                <div class="company-name-link" id="companyNameLink" style="display: none;">
                    <span class="company-name-clickable" id="clickableCompanyName"></span>
                </div>
                
                <!-- Basic Information Grid -->
                <div class="investment-summary-basic-info">
                    <div class="basic-info-item">
                        <span class="basic-info-label">Date</span>
                        <span class="basic-info-value" id="reportDate">-</span>
                    </div>
                    <div class="basic-info-item">
                        <span class="basic-info-label">Stock Price (Previous Close)</span>
                        <span class="basic-info-value" id="stockPrice">-</span>
                    </div>
                    <div class="basic-info-item">
                        <span class="basic-info-label">Market Cap</span>
                        <span class="basic-info-value" id="marketCap">-</span>
                    </div>
                    <div class="basic-info-item">
                        <span class="basic-info-label">Recommended Action</span>
                        <span class="basic-info-value">
                            <span class="recommended-action" id="recommendedAction">-</span>
                        </span>
                    </div>
                    <div class="basic-info-item">
                        <span class="basic-info-label">Industry</span>
                        <span class="basic-info-value" id="industry">-</span>
                    </div>
                </div>
            </div>
            
            <!-- Business Overview -->
            <div class="investment-summary-section">
                <div class="section-header">Business Overview</div>
                <div class="section-content" id="businessOverview">
                    <!-- Content will be populated here -->
                </div>
            </div>
            
            <!-- Business Performance -->
            <div class="investment-summary-section">
                <div class="section-header">Business Performance</div>
                <div class="section-content" id="businessPerformance">
                    <!-- Content will be populated here -->
                </div>
            </div>
            
            <!-- Industry Context -->
            <div class="investment-summary-section">
                <div class="section-header">Industry Context</div>
                <div class="section-content" id="industryContext">
                    <!-- Content will be populated here -->
                </div>
            </div>
            
            <!-- Financial Stability and Debt Levels -->
            <div class="investment-summary-section">
                <div class="section-header">Financial Stability and Debt Levels</div>
                <div class="section-content" id="financialStability">
                    <!-- Content will be populated here -->
                </div>
            </div>
            
            <!-- Key Financials and Valuation -->
            <div class="investment-summary-section">
                <div class="section-header">Key Financials and Valuation</div>
                <div class="section-content" id="keyFinancialsValuation">
                    <!-- Content will be populated here -->
                </div>
            </div>
            
            <!-- Big Trends and Big Events -->
            <div class="investment-summary-section">
                <div class="section-header">Big Trends and Big Events</div>
                <div class="section-content" id="bigTrendsEvents">
                    <!-- Content will be populated here -->
                </div>
            </div>
            
            <!-- Customer Segments and Demand Trends -->
            <div class="investment-summary-section">
                <div class="section-header">Customer Segments and Demand Trends</div>
                <div class="section-content" id="customerSegments">
                    <!-- Content will be populated here -->
                </div>
            </div>
            
            <!-- Competitive Landscape -->
            <div class="investment-summary-section">
                <div class="section-header">Competitive Landscape</div>
                <div class="section-content" id="competitiveLandscape">
                    <!-- Content will be populated here -->
                </div>
            </div>
            
            <!-- Risks and Anomalies -->
            <div class="investment-summary-section">
                <div class="section-header">Risks and Anomalies</div>
                <div class="section-content" id="risksAnomalies">
                    <!-- Content will be populated here -->
                </div>
            </div>
            
            <!-- Forecast and Outlook -->
            <div class="investment-summary-section">
                <div class="section-header">Forecast and Outlook</div>
                <div class="section-content" id="forecastOutlook">
                    <!-- Content will be populated here -->
                </div>
            </div>
            
            <!-- Leading Investment Firms and Views -->
            <div class="investment-summary-section">
                <div class="section-header">Leading Investment Firms and Views</div>
                <div class="section-content" id="investmentFirmsViews">
                    <!-- Content will be populated here -->
                </div>
            </div>
            
            <!-- Recommended Action -->
            <div class="investment-summary-section">
                <div class="section-header">Recommended Action</div>
                <div class="section-content" id="recommendedActionDetail">
                    <!-- Content will be populated here -->
                </div>
            </div>
            
            <!-- Industry Ratio and Metric Analysis -->
            <div class="investment-summary-section">
                <div class="section-header">Industry Ratio and Metric Analysis</div>
                <div class="section-content" id="industryRatioAnalysis">
                    <!-- Content will be populated here -->
                </div>
            </div>
            
            
            <!-- Key Takeaways -->
            <div class="investment-summary-section">
                <div class="section-header">Key Takeaways</div>
                <div class="section-content" id="keyTakeaways">
                    <!-- Content will be populated here -->
                </div>
            </div>
            
        </div>
    </div>

    <script>
        class InvestmentSummaryPage {
            constructor() {
                this.companyId = null;
                this.companyName = null;
                this.apiClient = null;
                this.init();
            }

            init() {
                // Get URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                this.companyId = urlParams.get('id');
                this.companyName = urlParams.get('company');
                
                // Update breadcrumb with company name
                this.updateBreadcrumb();
                
                // Setup global back navigation
                this.setupGlobalBackNavigation();
                
                // Initialize API client
                this.initApiClient();
                
                // Load investment summary data
                this.loadInvestmentSummary();
            }

            updateBreadcrumb() {
                if (this.companyName) {
                    document.title = `${this.companyName} - Investment Summary - Chinese Stock Dashboard`;
                } else {
                    document.title = 'Investment Summary - Chinese Stock Dashboard';
                }
            }

            setupGlobalBackNavigation() {
                // No longer needed - using clickable company name instead
            }

            initApiClient() {
                // Import API client configuration with cache busting
                const script = document.createElement('script');
                script.src = '../config/csi300_api_config.js?v=' + Date.now();
                script.onload = () => {
                    const apiScript = document.createElement('script');
                    apiScript.src = '../assets/js/utils/csi300_api_client.js?v=' + Date.now();
                    apiScript.onload = () => {
                        // Use the global API client instance that has all methods
                        this.apiClient = window.csi300ApiClient;
                    };
                    document.head.appendChild(apiScript);
                };
                document.head.appendChild(script);
            }

            async loadInvestmentSummary() {
                if (!this.companyId) {
                    this.showError('Company ID not provided');
                    return;
                }

                try {
                    // Wait for API client to be ready
                    while (!this.apiClient) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }

                    console.log(`Loading investment summary for company ID: ${this.companyId}`);
                    
                    // Use API client method for consistent configuration and error handling
                    const investmentSummary = await this.apiClient.getInvestmentSummary(this.companyId);
                    console.log('Investment summary loaded:', investmentSummary);
                    
                    this.renderInvestmentSummary(investmentSummary);
                    
                } catch (error) {
                    console.error('Error loading investment summary:', error);
                    this.showError('Failed to load investment summary. Please try again later.');
                }
            }

            renderInvestmentSummary(data) {
                // Hide loading state
                document.getElementById('loadingState').style.display = 'none';
                
                // Show content
                document.getElementById('investmentSummaryContent').style.display = 'block';
                
                // Update cached company name if provided in payload
                if (data.company_name) {
                    this.companyName = data.company_name;
                }
                
                // Update title and company name link
                document.getElementById('summaryTitle').textContent = 'Investment Summary';
                
                // Setup clickable company name
                const companyNameLink = document.getElementById('companyNameLink');
                const clickableCompanyName = document.getElementById('clickableCompanyName');
                if (companyNameLink && clickableCompanyName) {
                    clickableCompanyName.textContent = data.company_name || this.companyName;
                    companyNameLink.style.display = 'block';
                    
                    // Add click event listener
                    clickableCompanyName.addEventListener('click', () => {
                        this.goBackToCompanyDetail();
                    });
                }
                
                // Update basic information
                document.getElementById('reportDate').textContent = this.formatDate(data.report_date);
                document.getElementById('stockPrice').textContent = data.stock_price_previous_close
                    ? `CNY ${data.stock_price_previous_close}`
                    : '-';
                document.getElementById('marketCap').textContent = data.market_cap_display || '-';
                
                const recommendedActionElement = document.getElementById('recommendedAction');
                const actionText = data.recommended_action || '-';
                const actionClass = actionText === '-'
                    ? 'neutral'
                    : actionText.toLowerCase().replace(/\s+/g, '-');
                recommendedActionElement.textContent = actionText;
                recommendedActionElement.className = `recommended-action ${actionClass}`;
                
                // Get industry from company data or use a default
                const industryValue = data.industry || data.im_sector || '-';
                document.getElementById('industry').textContent = industryValue;
                
                // Update all sections
                this.updateSection('businessOverview', data.business_overview);
                this.updateSection('businessPerformance', data.business_performance);
                this.updateSection('industryContext', data.industry_context);
                this.updateSection('financialStability', data.financial_stability);
                this.updateSection('keyFinancialsValuation', data.key_financials_valuation);
                this.updateSection('bigTrendsEvents', data.big_trends_events);
                this.updateSection('customerSegments', data.customer_segments);
                this.updateSection('competitiveLandscape', data.competitive_landscape);
                this.updateSection('risksAnomalies', data.risks_anomalies);
                this.updateSection('forecastOutlook', data.forecast_outlook);
                this.updateSection('investmentFirmsViews', data.investment_firms_views);
                this.updateSection('recommendedActionDetail', data.recommended_action_detail);
                this.updateSection('industryRatioAnalysis', data.industry_ratio_analysis);
                this.updateSection('tariffsSupplyChainRisks', data.tariffs_supply_chain_risks);
                this.updateSection('keyTakeaways', data.key_takeaways);
                
                // Handle sources with links
                this.updateSourcesSection(data.sources);
                
                // Update page title
                const titleName = data.company_name || this.companyName || 'Company';
                document.title = `${titleName} - Investment Summary - Chinese Stock Dashboard`;

                // Update global navigation context with current company
                this.updateGlobalNavigationContext(data);
            }

            updateSection(elementId, content) {
                const element = document.getElementById(elementId);
                if (element && content) {
                    // Parse Markdown to HTML
                    if (typeof marked !== 'undefined') {
                        // Configure marked options
                        marked.setOptions({
                            breaks: true,        // Convert \n to <br>
                            gfm: true,          // GitHub Flavored Markdown
                            headerIds: false,   // Don't add IDs to headers
                            mangle: false       // Don't escape email addresses
                        });
                        
                        // Parse markdown and set HTML
                        element.innerHTML = marked.parse(content);
                    } else {
                        // Fallback to simple paragraph conversion if marked is not loaded
                        const paragraphs = content.split('\n').filter(p => p.trim()).map(p => `<p>${p.trim()}</p>`).join('');
                        element.innerHTML = paragraphs;
                    }
                }
            }

            updateSourcesSection(sources) {
                const element = document.getElementById('sources');
                if (element && sources) {
                    // Parse sources and create links
                    const sourceLines = sources.split('\n').filter(line => line.trim());
                    let sourcesList = '<ul class="sources-list">';
                    
                    sourceLines.forEach(line => {
                        // Check if line contains a URL in brackets
                        const urlMatch = line.match(/\[([^\]]+)\]\(([^)]+)\)/);
                        if (urlMatch) {
                            const text = line.replace(urlMatch[0], '');
                            const linkText = urlMatch[1];
                            const url = urlMatch[2];
                            sourcesList += `<li>${text.trim()} <a href="${url}" target="_blank">${linkText}</a></li>`;
                        } else {
                            sourcesList += `<li>${line.trim()}</li>`;
                        }
                    });
                    
                    sourcesList += '</ul>';
                    element.innerHTML = sourcesList;
                }
            }

            formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            }

            showError(message) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
                document.getElementById('errorState').innerHTML = `
                    <h3>Investment Summary Not Available</h3>
                    <p>${message}</p>
                `;

                if (window.CSI300GlobalNav && typeof window.CSI300GlobalNav.setCompanyContext === 'function') {
                    window.CSI300GlobalNav.setCompanyContext(null);
                }
            }

            goBackToCompanyDetail() {
                // Always go back to company detail page
                if (this.companyId) {
                    window.location.href = `../detail.html?id=${this.companyId}`;
                } else {
                    window.location.href = '../browser.html';
                }
            }

            updateGlobalNavigationContext(data) {
                if (!window.CSI300GlobalNav || typeof window.CSI300GlobalNav.setCompanyContext !== 'function') {
                    return;
                }

                window.CSI300GlobalNav.setCompanyContext({
                    id: this.companyId,
                    name: data.company_name || this.companyName || 'Company Insights',
                    imSector: data.im_sector || data.industry || ''
                });
            }
        }

        // Initialize the page
        const investmentSummaryPage = new InvestmentSummaryPage();
    </script>
</body>
</html>
