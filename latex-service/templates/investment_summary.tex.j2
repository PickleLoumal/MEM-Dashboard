%# ============================================================================
%# Investment Summary Report Template
%# ============================================================================
%# This is a Jinja2 LaTeX template for generating investment summary PDFs.
%#
%# Variables available:
%#   - summary: Investment summary data (from CSI300InvestmentSummary)
%#   - company: Company data (from CSI300Company)
%#   - charts: Dict of chart_name -> local_file_path
%#   - settings: Page settings
%#   - report_date: Formatted report date
%#
%# Jinja2 syntax for LaTeX (custom delimiters to avoid conflicts):
%#   - Variables: \VAR{ variable }
%#   - Blocks: \BLOCK{ for item in list }...\BLOCK{ endfor }
%#   - Comments: %# comment
%#   - Line statements: %% if condition
%#
%# Custom filters:
%#   - |escape: Escape LaTeX special characters
%#   - |escape_para: Escape with paragraph preservation
%#   - |number: Format number with thousands separator
%#   - |percentage: Format as percentage
%#   - |currency('USD'): Format as currency
%#   - |date: Format date
%# ============================================================================

%# Title Page
\begin{titlepage}
    \centering
    \vspace*{2cm}

    {\Huge\bfseries\color{primary} Investment Summary Report}

    \vspace{1cm}

    {\LARGE \VAR{ summary.company_name | escape }}

    \vspace{0.5cm}

    {\large \textcolor{textgray}{(\VAR{ company.ticker | escape })}}

    \vspace{2cm}

    \begin{tabular}{ll}
        \textbf{Exchange:} & \VAR{ company.exchange_code | escape } \\
        \textbf{Sector:} & \VAR{ company.sector | escape } \\
        \textbf{Report Date:} & \VAR{ report_date } \\
    \end{tabular}

    \vfill

    {\footnotesize Generated by ALFIE Investment Analysis System}

\end{titlepage}

%# Table of Contents
\tableofcontents
\newpage

%# ============================================================================
%# Executive Summary
%# ============================================================================
\section{Executive Summary}

\subsection{Investment Recommendation}

\begin{center}
\BLOCK{ if summary.recommended_action == 'BUY' }
    {\Huge\bfseries\color{secondary} ★ BUY ★}
\BLOCK{ elif summary.recommended_action == 'SELL' }
    {\Huge\bfseries\color{danger} ✕ SELL ✕}
\BLOCK{ elif summary.recommended_action == 'HOLD' }
    {\Huge\bfseries\color{accent} ◆ HOLD ◆}
\BLOCK{ else }
    {\Huge\bfseries\color{textgray} ? NEUTRAL ?}
\BLOCK{ endif }
\end{center}

\vspace{0.5cm}

\VAR{ summary.recommended_action_detail | escape_para }

\subsection{Key Highlights}

\begin{itemize}[leftmargin=*]
    \item \textbf{Stock Price:} \VAR{ company.previous_close | currency('USD') } (as of \VAR{ company.price_date | date })
    \item \textbf{Market Cap:} \VAR{ summary.market_cap_display | escape }
    \item \textbf{52-Week Range:} \VAR{ company.price_52w_low | currency('USD') } — \VAR{ company.price_52w_high | currency('USD') }
    \item \textbf{P/E Ratio:} \VAR{ company.pe_ratio_trailing | number }
    \item \textbf{EPS (TTM):} \VAR{ company.eps_trailing | currency('USD') }
    \item \textbf{Dividend Yield:} \VAR{ company.dividend_yield_fy0 | percentage }
\end{itemize}

%# ============================================================================
%# Company Overview
%# ============================================================================
\section{Company Overview}

\subsection{Business Description}

\VAR{ summary.business_overview | escape_para }

\subsection{Industry Position}

\begin{tabular}{ll}
    \textbf{Sector:} & \VAR{ company.sector | escape } \\
    \textbf{Industry:} & \VAR{ company.industry | escape } \\
    \textbf{Exchange:} & \VAR{ company.exchange_code | escape } \\
    \textbf{Country:} & \VAR{ company.country | escape } \\
\end{tabular}

%# ============================================================================
%# Financial Analysis
%# ============================================================================
\section{Financial Analysis}

\subsection{Valuation Metrics}

\begin{longtable}{lrr}
    \toprule
    \textbf{Metric} & \textbf{Value} & \textbf{Industry Avg} \\
    \midrule
    \endhead

    P/E Ratio (Trailing) & \VAR{ company.pe_ratio_trailing | number } & — \\
    P/E Ratio (Forward) & \VAR{ company.pe_ratio_forward | number } & — \\
    P/B Ratio & \VAR{ company.pb_ratio | number } & — \\
    P/S Ratio & \VAR{ company.ps_ratio | number } & — \\
    EV/EBITDA & \VAR{ company.ev_ebitda | number } & — \\

    \bottomrule
\end{longtable}

\subsection{Profitability Metrics}

\begin{longtable}{lr}
    \toprule
    \textbf{Metric} & \textbf{Value} \\
    \midrule
    \endhead

    Return on Equity (ROE) & \VAR{ company.roe_trailing | percentage } \\
    Return on Assets (ROA) & \VAR{ company.roa_trailing | percentage } \\
    Gross Margin & \VAR{ company.gross_margin | percentage } \\
    Operating Margin & \VAR{ company.operating_margin | percentage } \\
    Net Margin & \VAR{ company.net_margin | percentage } \\

    \bottomrule
\end{longtable}

\subsection{Business Performance}

\VAR{ summary.business_performance | escape_para }

\subsection{Financial Stability}

\VAR{ summary.financial_stability | escape_para }

\begin{longtable}{lr}
    \toprule
    \textbf{Metric} & \textbf{Value} \\
    \midrule
    \endhead

    Current Ratio & \VAR{ company.current_ratio | number } \\
    Quick Ratio & \VAR{ company.quick_ratio | number } \\
    Debt to Equity & \VAR{ company.debt_to_equity | number } \\
    Interest Coverage & \VAR{ company.interest_coverage | number } \\

    \bottomrule
\end{longtable}

%# ============================================================================
%# Charts
%# ============================================================================
\section{Visual Analysis}

\BLOCK{ if 'stock_price' in charts }
\subsection{Stock Price Performance}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{\VAR{ charts['stock_price'] }}
    \caption{52-Week Stock Price Performance}
\end{figure}
\BLOCK{ endif }

\BLOCK{ if 'roe_trend' in charts }
\subsection{Return on Equity Trend}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.85\textwidth]{\VAR{ charts['roe_trend'] }}
    \caption{Historical ROE Performance}
\end{figure}
\BLOCK{ endif }

\BLOCK{ if 'pe_ratio' in charts }
\subsection{P/E Ratio Trend}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.85\textwidth]{\VAR{ charts['pe_ratio'] }}
    \caption{Historical P/E Ratio vs Industry Average}
\end{figure}
\BLOCK{ endif }

\BLOCK{ if 'financial_summary' in charts }
\subsection{Financial Metrics Summary}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{\VAR{ charts['financial_summary'] }}
    \caption{Key Financial Metrics vs Benchmarks}
\end{figure}
\BLOCK{ endif }

%# ============================================================================
%# Risk Assessment
%# ============================================================================
\section{Risk Assessment}

\subsection{Identified Risks}

\VAR{ summary.risks_anomalies | escape_para }

\subsection{Risk Factors}

\begin{itemize}[leftmargin=*]
%# Parse risks if available as a structured list
\BLOCK{ if summary.risk_factors }
\BLOCK{ for risk in summary.risk_factors }
    \item \VAR{ risk | escape }
\BLOCK{ endfor }
\BLOCK{ else }
    \item Market volatility and economic conditions
    \item Industry-specific regulatory changes
    \item Competitive pressures
    \item Currency and interest rate fluctuations
\BLOCK{ endif }
\end{itemize}

%# ============================================================================
%# Growth Outlook
%# ============================================================================
\section{Growth Outlook}

\subsection{Analyst Projections}

\begin{longtable}{lr}
    \toprule
    \textbf{Metric} & \textbf{Estimate} \\
    \midrule
    \endhead

    EPS Growth (YoY) & \VAR{ company.eps_growth_percent | percentage } \\
    Revenue Growth & \VAR{ company.revenue_growth_percent | percentage } \\
    Target Price (Mean) & \VAR{ company.target_price_mean | currency('USD') } \\
    Target Price (High) & \VAR{ company.target_price_high | currency('USD') } \\
    Target Price (Low) & \VAR{ company.target_price_low | currency('USD') } \\

    \bottomrule
\end{longtable}

\subsection{Growth Analysis}

\VAR{ summary.growth_analysis | escape_para }

%# ============================================================================
%# Appendix
%# ============================================================================
\appendix
\section{Data Sources}

This report was generated using data from the following sources:

\begin{itemize}
    \item Market data: Refinitiv, Yahoo Finance
    \item Financial statements: Company filings, SEC EDGAR
    \item Analyst estimates: Refinitiv consensus
    \item Report generation: ALFIE Investment Analysis System
\end{itemize}

\section{Disclaimer}

\textcolor{textgray}{\small
This report is for informational purposes only and does not constitute investment advice.
Past performance is not indicative of future results.
Always conduct your own research and consult with a qualified financial advisor before making investment decisions.
}

\vfill

\begin{center}
{\footnotesize Report generated on \VAR{ report_date } by ALFIE}
\end{center}

